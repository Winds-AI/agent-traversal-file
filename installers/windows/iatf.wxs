<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!--
    IATF Tools Windows Installer (.msi)

    Build instructions:
    1. Install WiX Toolset: https://wixtoolset.org/
    2. Place iatf.exe in same directory as this file
    3. Run: candle iatf.wxs
    4. Run: light -ext WixUIExtension -out iatf-tools-1.0.0.msi iatf.wixobj
  -->

  <Product
    Id="*"
    Name="IATF Tools"
    Language="1033"
    Version="$(var.ProductVersion)"
    Manufacturer="IATF Project"
    UpgradeCode="12345678-1234-1234-1234-123456789ABC">

    <Package
      InstallerVersion="200"
      Compressed="yes"
      InstallScope="perMachine"
      Platform="x64"
      Description="IATF - Indexed Agent Traversable File Tools"
      Comments="Self-indexing document format for AI agents" />

    <!-- Major upgrade support -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <!-- Embed CAB in MSI -->
    <MediaTemplate EmbedCab="yes" />

    <!-- License (MIT) -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Desktop shortcut property (checkbox in UI) -->
    <Property Id="INSTALLDESKTOPSHORTCUT" Value="1" />

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Install to Program Files -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="IATF Tools">

          <!-- Main executable -->
          <Component Id="AtfExecutable" Guid="87654321-4321-4321-4321-210987654321">
            <File
              Id="AtfExe"
              Source="iatf.exe"
              KeyPath="yes"
              Checksum="yes" />

            <!-- Add to system PATH -->
            <Environment
              Id="PATH"
              Name="PATH"
              Value="[INSTALLFOLDER]"
              Permanent="no"
              Part="last"
              Action="set"
              System="yes" />
          </Component>

          <!-- Documentation -->
          <Component Id="Documentation" Guid="11111111-2222-3333-4444-555555555555">
            <File Id="ReadmeTxt" Source="README.txt" KeyPath="yes" />
            <File Id="LicenseTxt" Source="LICENSE.txt" />
          </Component>

          <!-- File association for .iatf files -->
          <Component Id="IatfFileAssociation" Guid="33333333-4444-5555-6666-777777777777">
            <!-- Register .iatf extension -->
            <RegistryValue
              Root="HKLM"
              Key="SOFTWARE\Classes\.iatf"
              Type="string"
              Value="IATFFile"
              KeyPath="yes" />
            <!-- Define file type -->
            <RegistryValue
              Root="HKLM"
              Key="SOFTWARE\Classes\IATFFile"
              Type="string"
              Value="IATF Document" />
            <!-- Set icon for .iatf files (uses exe icon) -->
            <RegistryValue
              Root="HKLM"
              Key="SOFTWARE\Classes\IATFFile\DefaultIcon"
              Type="string"
              Value="[SystemFolder]shell32.dll,1" />
            <!-- Open command -->
            <RegistryValue
              Root="HKLM"
              Key="SOFTWARE\Classes\IATFFile\shell\open\command"
              Type="string"
              Value=""[INSTALLFOLDER]iatf.exe" read "%1"" />
            <!-- Edit command (opens with iatf for editing) -->
            <RegistryValue
              Root="HKLM"
              Key="SOFTWARE\Classes\IATFFile\shell\edit\command"
              Type="string"
              Value=""[INSTALLFOLDER]iatf.exe" rebuild "%1"" />
          </Component>

        </Directory>
      </Directory>

      <!-- Desktop shortcut (conditional) -->
      <Directory Id="DesktopFolder">
        <Component Id="DesktopShortcut" Guid="44444444-5555-6666-7777-888888888888">
          <Condition>INSTALLDESKTOPSHORTCUT</Condition>
          <Shortcut
            Id="DesktopIatfShortcut"
            Name="IATF Tools"
            Description="IATF - Indexed Agent Traversable File Tools"
            Target="[SystemFolder]cmd.exe"
            Arguments="/k echo IATF Tools installed. Type 'iatf --help' to get started." />
          <RegistryValue
            Root="HKCU"
            Key="Software\IATF\IATF Tools"
            Name="DesktopShortcut"
            Type="integer"
            Value="1"
            KeyPath="yes" />
        </Component>
      </Directory>

      <!-- Start Menu shortcut -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="IATF Tools">
          <Component Id="ApplicationShortcut" Guid="22222222-3333-4444-5555-666666666666">
            <Shortcut
              Id="ReadmeShortcut"
              Name="IATF Tools README"
              Description="IATF Tools Documentation"
              Target="[INSTALLFOLDER]README.txt"
              WorkingDirectory="INSTALLFOLDER" />

            <Shortcut
              Id="UninstallShortcut"
              Name="Uninstall IATF Tools"
              Description="Uninstalls IATF Tools"
              Target="[SystemFolder]msiexec.exe"
              Arguments="/x [ProductCode]" />

            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
            <RegistryValue
              Root="HKCU"
              Key="Software\IATF\IATF Tools"
              Type="string"
              Value=""
              KeyPath="yes" />
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <!-- Features to install -->
    <Feature Id="ProductFeature" Title="IATF Tools" Level="1">
      <ComponentRef Id="AtfExecutable" />
      <ComponentRef Id="Documentation" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="IatfFileAssociation" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <!-- UI -->
    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <UIRef Id="WixUI_ErrorProgressText" />
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2">1</Publish>
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="1">NOT Installed</Publish>
    </UI>

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

  </Product>
</Wix>
